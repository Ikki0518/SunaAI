# Suna セキュリティガイド

## 概要

このドキュメントでは、Sunaアプリケーションに実装されたセキュリティ機能と管理ツールについて説明します。

## 実装されたセキュリティ機能

### 1. 認証とアクセス制御

#### 多要素認証対応
- **メール/パスワード認証**: bcryptによるパスワードハッシュ化
- **Google OAuth**: Google アカウントでのソーシャルログイン
- **管理者権限**: 特定のメールアドレスによる管理者アクセス制御

#### パスワードセキュリティ
- **強度チェック**: 8文字以上、大文字・小文字・数字・記号の組み合わせ
- **一般的なパスワードの拒否**: よく使われるパスワードのブラックリスト
- **ハッシュ化**: bcrypt（コスト12）による安全なパスワード保存

### 2. ブルートフォース攻撃対策

#### 失敗試行の監視
- **試行回数制限**: 5回の失敗でアカウント一時ブロック
- **ブロック期間**: 30分間のアクセス制限
- **自動リセット**: 1時間後に試行回数をリセット

#### レート制限
- **API制限**: 15分間で10リクエストまで
- **IP制限**: 5分間で20リクエストまで
- **自動クリーンアップ**: 古いデータの定期削除

### 3. セキュリティ監視

#### リアルタイム監視
- **ログイン活動**: 成功・失敗の全記録
- **不審な活動**: ボット検出、異常なアクセスパターン
- **セキュリティイベント**: 重要度別の分類と記録

#### ログ記録
- **Google Sheets連携**: 全ユーザー活動の自動記録
- **ローカルログ**: セキュリティイベントのJSON保存
- **管理者通知**: 重要度の高いイベントのコンソール出力

## 管理ツール

### 1. 管理者ダッシュボード (`/admin/dashboard`)

#### 概要タブ
- **統計情報**: 総ユーザー数、ログイン数、今日の活動
- **最近の活動**: 直近のユーザーアクション一覧

#### ユーザー活動タブ
- **詳細履歴**: 全ユーザーの活動履歴
- **フィルタリング**: 日付、アクション種別での絞り込み
- **ページネーション**: 大量データの効率的な表示

#### セキュリティタブ
- **セキュリティイベント**: 失敗ログイン、不審な活動
- **重要度別表示**: Critical > High > Medium > Low
- **詳細情報**: IP アドレス、User-Agent、タイムスタンプ

#### ユーザー管理タブ
- **将来実装予定**: アカウント有効化/無効化、権限管理

### 2. 基本統計ダッシュボード (`/admin`)

- **簡易統計**: ユーザー数、ログイン数の基本情報
- **Google Sheets連携状況**: 設定状態の確認
- **高度な管理ツールへのリンク**: フル機能ダッシュボードへの導線

## API エンドポイント

### 管理者専用 API

#### `/api/admin/stats` (GET)
- **機能**: 統計情報の取得
- **権限**: 管理者のみ
- **レスポンス**: ユーザー数、ログイン数、今日の活動数

#### `/api/admin/activities` (GET)
- **機能**: ユーザー活動履歴の取得
- **権限**: 管理者のみ
- **パラメータ**: limit, offset (ページネーション)

#### `/api/admin/security-events` (GET/POST)
- **機能**: セキュリティイベントの取得・作成
- **権限**: 管理者のみ
- **フィルタ**: 重要度別の絞り込み

### ユーザー追跡 API

#### `/api/user-tracking` (GET/POST)
- **機能**: ユーザー活動の記録・統計取得
- **自動実行**: 認証時に自動記録
- **Google Sheets**: 環境変数設定時に自動連携

## セキュリティ設定

### 環境変数

```bash
# 認証設定
NEXTAUTH_SECRET=your-secret-key
NEXTAUTH_URL=http://localhost:3000

# Google OAuth (オプション)
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Google Sheets連携 (オプション)
GOOGLE_SHEETS_ID=your-spreadsheet-id
GOOGLE_SERVICE_ACCOUNT_EMAIL=your-service-account@project.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
```

### 管理者設定

現在の管理者メールアドレス:
- `ikki_y0518@icloud.com`
- `ikkiyamamoto0518@gmail.com`

管理者の追加・変更は以下のファイルで設定:
- `app/lib/auth.ts`
- `app/api/admin/*/route.ts`

## セキュリティベストプラクティス

### 1. パスワード管理
- **強力なパスワード**: 12文字以上、複数の文字種を組み合わせ
- **定期変更**: 重要なアカウントは定期的にパスワード変更
- **パスワードマネージャー**: 安全なパスワード管理ツールの使用

### 2. アクセス管理
- **最小権限の原則**: 必要最小限の権限のみ付与
- **定期監査**: アクセス権限の定期的な見直し
- **ログ監視**: 不審な活動の早期発見

### 3. システム管理
- **定期更新**: 依存関係とセキュリティパッチの適用
- **バックアップ**: 重要なデータの定期バックアップ
- **監視**: システムの継続的な監視

### 4. インシデント対応
- **早期発見**: セキュリティイベントの迅速な検知
- **迅速な対応**: インシデント発生時の適切な対処
- **事後分析**: インシデントの原因分析と再発防止

## 監視すべきセキュリティイベント

### Critical (緊急)
- **システム侵害**: 不正アクセスの成功
- **データ漏洩**: 機密情報の不正取得
- **権限昇格**: 不正な管理者権限取得

### High (高)
- **複数回の失敗ログイン**: ブルートフォース攻撃の可能性
- **異常なアクセスパターン**: 自動化ツールによる攻撃
- **管理者アカウントへの攻撃**: 特権アカウントの標的化

### Medium (中)
- **単発の失敗ログイン**: 一般的なログイン失敗
- **不審なUser-Agent**: ボットや自動化ツール
- **レート制限の超過**: 大量リクエストの検知

### Low (低)
- **一般的なアクセス**: 通常の利用パターン
- **設定変更**: ユーザーによる正常な設定変更

## トラブルシューティング

### よくある問題

#### 1. Google Sheets連携が動作しない
- **原因**: 環境変数の設定不備
- **解決**: `GOOGLE_SHEETS_SETUP.md` を参照して正しく設定

#### 2. 管理者ダッシュボードにアクセスできない
- **原因**: 管理者権限がない
- **解決**: 設定されたメールアドレスでログイン

#### 3. セキュリティイベントが記録されない
- **原因**: ファイル書き込み権限の不足
- **解決**: `data/` ディレクトリの権限確認

### ログの確認

```bash
# 開発環境でのログ確認
npm run dev

# セキュリティイベントファイルの確認
cat data/security-events.json

# ユーザーデータの確認
cat data/users.json
```

## 今後の改善予定

### 短期 (1-2ヶ月)
- **2FA実装**: SMS/アプリベースの二要素認証
- **IP制限**: 地理的制限とホワイトリスト
- **詳細ログ**: より詳細なアクセスログ

### 中期 (3-6ヶ月)
- **機械学習**: 異常検知の精度向上
- **自動対応**: 脅威の自動ブロック
- **レポート機能**: 定期的なセキュリティレポート

### 長期 (6ヶ月以上)
- **SIEM連携**: セキュリティ情報・イベント管理システム
- **コンプライアンス**: GDPR、SOC2等の対応
- **ペネトレーションテスト**: 定期的なセキュリティ診断

## 連絡先

セキュリティに関する問題や質問がある場合は、管理者にお問い合わせください。

---

**最終更新**: 2025年6月12日  
**バージョン**: 1.0.0